<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AU List | My AUS Wiki</title>
  <link rel="stylesheet" href="style.css">
  
  <style>
    /* Each AU item will have a border */
    .au-item {
      background-color: #1a1a1a;
      border: 1px solid #444;
      padding: 10px 15px;
      margin-bottom: 15px;
      border-radius: 5px;
      overflow: hidden; /* Added to contain the floated button */
    }
    .au-item h3 {
      color: #ffff00; /* Yellow color like the title */
      margin-top: 0;
      border-bottom: 1px dashed #555;
      padding-bottom: 5px;
      
      /* Small change so the title doesn't overlap the delete button */
      margin-right: 60px; 
    }
    .au-item strong {
      color: #ccc;
    }
    
    /* --- NEW CSS FOR DELETE BUTTON --- */
    .delete-btn {
      background-color: #7d0000; /* Dark red */
      color: #ffcccc;
      border: 1px solid #ff0000;
      padding: 3px 8px;
      font-size: 0.8em;
      border-radius: 4px;
      cursor: pointer;
      float: right; /* Push the button to the right */
    }
    .delete-btn:hover {
      background-color: #ff0000;
      color: #fff;
    }
  </style>
</head>
<body>

    <header>
        <h1>Dusttale</h1>
    </header>

    <nav>
        <ul>
            <li><a href="index.html">Home</a></li>
            <li><a href="aus.html" class="active">AU List</a></li>
            <li><a href="create-aus.html">Create AU</a></li>
            <li><a href="characters.html">Characters</a></li>
            <li><a href="contribute.html">Contribute</a></li>
        </ul>
    </nav>

    <main id="au-list-container">
      
        <h2>AU List</h2>
        <p>Loading list from server...</p>

    </main>

    <footer>
        <p>&copy; 2025 Dust!Sans [Elliot Davidson]. All rights reserved.</p>
        <p>Website developed based on the Undertale fan community. Undertale belongs to Toby Fox. The Dusttale AU belongs to its creator.</p>
    </footer>

    <script>
      window.addEventListener('DOMContentLoaded', () => {
        loadAUs();
        setupDeleteListener(); 
      });

      // FUNCTION TO LOAD DATA (FIXED XSS AND ADDED BUTTON)
      async function loadAUs() {
        const BACKEND_URL = 'https://dust-aus-backend.onrender.com/aus';
        const main = document.getElementById('au-list-container');
        
        try {
          const response = await fetch(BACKEND_URL);
          if (!response.ok) throw new Error('Server Error: ' + response.status);
          
          const aus = await response.json();
          main.innerHTML = ''; 
          
          const title = document.createElement('h2');
          title.textContent = 'AU List';
          main.appendChild(title);

          if (aus.length === 0) {
            main.innerHTML += '<p>No AUs have been submitted yet. Be the first to contribute!</p>';
            main.innerHTML += '<p><a href="create-aus.html">Click here to create a new AU</a>.</p>';
          } else {
            
            // --- START OF UPGRADED LOOP (SAFE + DELETE BUTTON) ---
            aus.forEach(au => {
              const article = document.createElement('article');
              article.className = 'au-item';

              // --- DELETE BUTTON (NEW) ---
              const deleteButton = document.createElement('button');
              deleteButton.textContent = 'Delete';
              deleteButton.className = 'delete-btn';
              deleteButton.dataset.id = au._id; // <-- Important: MongoDB ID
              article.appendChild(deleteButton);
              // --- END OF DELETE BUTTON ---

              const h3 = document.createElement('h3');
              h3.textContent = au.name;
              article.appendChild(h3);
              
              const pAuthor = document.createElement('p');
              pAuthor.innerHTML = '<strong>Creator:</strong> ';
              pAuthor.appendChild(document.createTextNode(au.author || 'Unknown'));
              article.appendChild(pAuthor);

              const pDesc = document.createElement('p');
              pDesc.textContent = au.desc;
              article.appendChild(pDesc);

              if (au.link && au.link.trim() !== '') {
                const pLink = document.createElement('p');
                const a = document.createElement('a');
                a.href = au.link;
                a.target = '_blank';
                a.rel = 'noopener noreferrer';
                a.textContent = 'View Link';
                pLink.appendChild(a);
                article.appendChild(pLink);
              }
              
              main.appendChild(article);
            });
            // --- END OF UPGRADED LOOP ---
          }
        } catch (error) {
          console.error('Could not load AUs:', error);
          main.innerHTML = '<h2>An Error Occurred</h2>';
          main.innerHTML += '<p>Could not load the AU list from the server. Please try again later.</p>';
          main.innerHTML += `<p><i>Error details: ${error.message}</i></p>`;
        }
      } // <-- Closes loadAUs function

      // --- NEW SECTION: DELETE HANDLING ---

      // 1. Setup the listener
      function setupDeleteListener() {
        const main = document.getElementById('au-list-container');
        // Listen for all clicks within the <main> tag
        main.addEventListener('click', (e) => {
          // Only act if the clicked element has the class 'delete-btn'
          if (e.target.classList.contains('delete-btn')) {
            handleDelete(e.target);
          }
        });
      }

      // 2. Main delete function
      async function handleDelete(button) {
        const auId = button.dataset.id; // Get the ID from the button
        const auName = button.closest('.au-item').querySelector('h3').textContent;

        // 3. Request Password (Admin Token)
        const token = prompt(`Are you sure you want to delete "${auName}"?\n\nEnter the Admin Password to confirm:`);

        if (!token) {
          return; // User clicked Cancel
        }

        // 4. Send the DELETE request to the server
        const BACKEND_URL = 'https://dust-aus-backend.onrender.com/aus';
        button.textContent = 'Deleting...';
        button.disabled = true;

        try {
          const response = await fetch(`${BACKEND_URL}/${auId}`, {
            method: 'DELETE',
            headers: {
              // Send the secret "key" in the header
              'Authorization': token 
            }
          });

          if (response.ok) {
            // 5. If successful, remove the AU from the webpage
            button.closest('.au-item').remove();
            alert(`Successfully deleted "${auName}"!`);
          } else {
            // 6. If failed (wrong password, server error)
            const error = await response.json();
            alert(`Deletion failed: ${error.message}`);
            button.textContent = 'Delete';
            button.disabled = false;
          }

        } catch (err) {
          console.error('Error during deletion:', err);
          alert('Connection error while attempting to delete.');
          button.textContent = 'Delete';
          button.disabled = false;
        }
      }
      // --- END OF NEW SECTION ---
    </script>
</body>
</html>
